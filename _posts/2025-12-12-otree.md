---
layout: post
title: oTreeに関するメモ
date: 2025-12-22 10:30:00
description: oTreeの使い方やTipsなどのメモ
tags: coding, otree
categories: note
related_posts: false
toc:
  sidebar: left
  max_heading_level: 2
---

# oTreeのAPI

oTreeには、外部プログラム（他のWebサイトなど）がoTreeと通信できるようにする REST API があります。

> ##### そもそも「REST API」って何?
>ざっくり言うと、ブラウザ上で操作して閲覧できるデータを、プログラムからも同様に取得するための「窓口」です。
> REST API を利用することで、同じ操作を再現可能な自動処理として実行できるため、定期的なデータの取得や、複数セッションの一括取得など、手作業では煩雑になりがちな処理を効率化できます。
{: .block-tip }

## oTreeのAPIでデータを取得する

oTreeで実験を実施後、取得されたデータは、画面上部の```メニュー```内にある```Data```から、```CSV```ファイルなどを手動でダウンロードすることが可能です。

ただ、参加者が増えてセッション数が多くなったり、データ取得と分析を繰り返し行う場合には、REST APIを用いてデータを自動取得する方法が便利です。

{% include figure.liquid loading="eager" path="assets/img/otree/otree_data_api.png" class="img-fluid rounded z-depth-1" %}

```Data```画面の ```Show API URLs``` を開くと、データ取得用のエンドポイント（例：```/api/export_wide```）が表示されます。これらのURLに対して HTTPのGETリクエスト を送ることで、ブラウザでのダウンロード操作を行わなくても、プログラムからCSVを取得できます。たとえば、全アプリを1ファイルにまとめた wide 形式のデータは次のURLで取得できます。

- 全データ（wide形式）：```/api/export_wide```

- Excel向け（BOM付き）：```/api/export_wide?format=csv_bom```

- セッション限定：```/api/export_wide?session_code={SESSION_CODE}```

実際の取得は、Python などのHTTPクライアントを使って行うことが多いです。

例えばPythonを使う場合は以下のようになります。

{% highlight python linenos %}
import requests
import pandas as pd
from io import BytesIO

url = "http://localhost:8000/api/export_app"  # APIのエンドポイントURL
params = {"app": "questionnaire"}  # 取得するアプリ名を指定
headers = {
    "Authorization": "Token YOUR_API_TOKEN"  # 認証用のAPIトークン
}

# GETリクエストを送信してデータを取得
r = requests.get(url, params=params, headers=headers)
print(f"URL requested: {r.url}")  # リクエストしたURLを表示
r.raise_for_status()  # エラーがあれば例外を発生させる

# レスポンスのバイナリデータをPandas DataFrameに変換
df = pd.read_csv(BytesIO(r.content))

# CSVファイルとして保存
with open("questionnaire.csv", "wb") as f:
    f.write(r.content)
{% endhighlight %}

このようにREST APIを用いることで、(1) セッションごとのデータ収集、(2) 定期的な自動ダウンロード、(3) 分析スクリプトとの連携による再現性の確保、が容易になります。特に、実験を複数回実施する場合や、データ取得から前処理・分析までを一連のパイプラインとして管理したい場合に有効です。